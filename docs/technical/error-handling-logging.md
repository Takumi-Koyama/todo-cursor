# エラー処理とロギングの検討

TODOアプリにおける適切なエラー処理とロギング戦略について検討しました。

## 1. 実装方針（結論）

### エラー処理
- Laravelの標準エラーハンドラをカスタマイズ
- カスタム例外クラスの階層設計
- 開発環境と本番環境でのエラー表示の切り分け
- SweetAlert2を使用したフラッシュメッセージ

### ロギング
- 開発環境: ファイルログ（詳細レベル）
- 本番環境: ファイルログ + 重要エラーはSlack通知
- ログローテーション: 日次、14日間保持

### 監査ログ
- `spatie/laravel-activitylog`パッケージを利用
- 記録対象: 重要アクション（作成/編集/削除）に限定
- 保存期間: 3ヶ月自動削除
- パフォーマンス対策: 非同期処理やキューの活用

## 2. 検討内容

### エラー処理の検討

#### エラーの分類と対応方法
- **バリデーションエラー**
  - Form Request Validationの活用
  - リアルタイムバリデーション（JS連携）
  - エラーメッセージの国際化対応

- **システムエラー**
  - 例外ハンドリングのカスタマイズ（Handler.php）
  - ユーザーフレンドリーなエラー画面
  - 環境ごとの詳細表示切り替え

- **ビジネスロジックエラー**
  - カスタム例外クラスの作成
  - ドメイン固有のエラーコード設計

#### エラー表示のUI設計
- フラッシュメッセージ（SweetAlert2など）
- インラインエラー表示（バリデーション）
- エラー専用ページ（404, 500など）

### ロギングの検討

#### ログレベルの使い分け
- **emergency/alert**: システム停止級のエラー
- **critical/error**: 運用影響あるエラー
- **warning**: 将来的に問題になる可能性
- **notice/info**: 運用監視情報
- **debug**: 開発時のみ必要な情報

#### ログの保存先オプション
- **ファイル**: 標準的な方法（dailyローテーション）
- **データベース**: 構造化データとして検索可能
- **Slack/Discord**: 即時通知が必要な重要エラー
- **外部サービス**: Sentry, Bugsnag, Rollbar等

#### コンテキスト情報の付加
- ユーザーID/セッション情報
- リクエスト情報（URL, パラメータ）
- 実行環境情報

### 監視とアラートの検討

#### アラート設定
- 重大エラー発生時のSlack/メール通知
- エラー率の閾値設定

#### パフォーマンス監視
- スロークエリのロギング
- リクエスト処理時間の計測

### 監査ログの検討

#### 監査ログの目的と内容
監査ログはシステム内でユーザーが行った重要な操作を時系列で記録するものです。

**記録対象のアクション例**:
- TODO作成時のログ
- TODO編集時のログ（変更前後の値）
- TODO削除時のログ
- TODO完了/未完了の状態変更
- カテゴリ/タグの操作

**記録する情報**:
- 操作したユーザーのID
- 操作日時
- 操作種別（作成/編集/削除など）
- 操作対象（ID、種別）
- 変更前後の値（編集の場合）

#### 監査ログの実装方法の選択肢

##### 選択肢1: イベントリスナーによる実装
```php
// AppServiceProviderで登録
Todo::created(function ($todo) {
    Log::info('TODO作成: ' . $todo->title, [
        'user_id' => auth()->id(),
        'todo_id' => $todo->id
    ]);
});
```

##### 選択肢2: 専用テーブルとモデルによる実装
```php
// AuditLogモデルとaudit_logsテーブルを作成
AuditLog::create([
    'user_id' => auth()->id(),
    'action' => 'todo_created',
    'resource_type' => 'todo',
    'resource_id' => $todo->id,
    'old_values' => null,
    'new_values' => $todo->toJson(),
]);
```

##### 選択肢3: 専用パッケージの利用
- `spatie/laravel-activitylog`などのパッケージを使用

#### 監査ログのメリット・デメリット

##### メリット
- **トラブルシューティング**: データの変更履歴を追跡可能
- **セキュリティ監視**: 不審な操作の検知
- **コンプライアンス**: 規制要件への対応（必要な場合）
- **ユーザーサポート**: ユーザーからの「データが消えた」等の問い合わせ対応

##### デメリット
- **パフォーマンスへの影響**: 追加のDB書き込みによる処理時間の増加
- **ストレージ消費**: ログデータの蓄積によるディスク容量の圧迫
- **実装・保守コスト**: 監査ログ機能の設計・実装・保守の追加工数
- **複雑性の増加**: システム全体の複雑性が増す
- **オーバーエンジニアリングのリスク**: 必要性と比較して過剰な機能となる可能性

## 3. 選択理由

### エラー処理の選択理由
- **標準エラーハンドラのカスタマイズ**: Laravelの基本機能を活用しつつ、アプリ固有の要件に対応
- **カスタム例外クラス**: ビジネスロジックのエラーを明確に区別し、適切な対応が可能
- **環境別の表示切り分け**: 開発時はデバッグ情報を、本番では安全な情報を表示

### ロギングの選択理由
- **ファイルログ**: 最も一般的で導入コストが低い
- **Slack通知**: 重要エラーに即時対応するため、通知機能を追加
- **14日間保持**: ストレージ使用量とトラブルシューティングに必要な期間のバランス

### 監査ログの選択理由
- **専用パッケージの採用**: 自前実装よりもメンテナンスコストが低く、機能が充実
- **重要アクションのみ記録**: パフォーマンス影響を最小限に抑えつつ、重要な情報を確保
- **3ヶ月保持**: ユーザーサポートの期間と保存コストのバランス
- **非同期処理**: ユーザー体験への影響を最小限に抑える

この方針により、開発効率を維持しつつ、適切なエラー対応と運用監視が可能になります。監査ログについては、初期段階ではシンプルに実装し、必要に応じて拡張していくアプローチを採用します。 