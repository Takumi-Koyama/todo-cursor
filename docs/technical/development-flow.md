# API開発フロー

# ⚠️ 最重要ルール ⚠️
**各ステップが完了したら必ず作業を中断し、次のステップに進む前にレビューと承認を得ること。**
この原則に従わない場合、手戻りや品質問題が発生する可能性があります。

## 概要

本プロジェクトでは、以下の4ステップで一貫したAPI開発を行います。この開発フローに従うことで、品質を維持しながら効率的に開発を進めることができます。

## 開発フロー

### 1. OpenAPI仕様の確認

- `docs/openapi.yaml`に定義されているAPIエンドポイントの仕様を確認します
- リクエスト・レスポンスの形式、パラメータ、認証要件などを理解します
- 実装前にスキーマと例を注意深く確認します

**成果物**: API仕様の理解と実装スコープの確定  
**確認ポイント**: 仕様の理解が正しいかチェック

👉 **ここで作業を停止し、仕様理解の確認を受けてください**

### 2. テストコードの実装

- 仕様に基づいてテストケースを作成します
- 主に以下のパターンをカバーします:
  - 成功ケース: 正常なリクエストで期待通りのレスポンスが返ることを確認
  - 認証エラー: 認証が必要なエンドポイントで適切なエラーレスポンスが返ることを確認
  - バリデーションエラー: 不正な入力に対して適切なバリデーションエラーが返ることを確認
  - 権限エラー: 権限がない場合に適切なエラーレスポンスが返ることを確認
- テストクラスは `src/tests/Feature/` 配下に配置します

**成果物**: 仕様をカバーする包括的なテストコード  
**確認ポイント**: テストケースの網羅性とエッジケースの考慮

👉 **ここで作業を停止し、テストコードのレビューと承認を受けてください**

### 3. シンプルな実装

- テストにパスするための最小限の実装を行います
- この段階ではコードの整理より機能の実装を優先します
- 具体的に以下の作業を行います:
  - `src/routes/api.php`にルートを追加
  - コントローラーをシンプルに実装
  - 必要最小限のロジックのみ記述

**成果物**: 機能する最小限のAPI実装  
**確認ポイント**: 実装の正確性とテスト合格

👉 **ここで作業を停止し、実装のレビューと承認を受けてください**

### 4. リファクタリング

- プロジェクトの設計方針に従ってコードをリファクタリングします
- 主に以下の改善を行います:
  - FormRequestクラスを使用したバリデーションの分離
  - Resourceクラスを使用したレスポンスのフォーマット統一
  - ビジネスロジックの整理
  - 適切なエラーハンドリング
- 各クラスの責務の明確化と単一責任の原則に従います

**成果物**: クリーンでメンテナンス性の高いコード  
**確認ポイント**: コード品質とプロジェクト規約への準拠

👉 **ここで作業を停止し、最終的なコードレビューと承認を受けてください**

## 各ステップ後の確認プロセス

各ステップ完了後は、以下のプロセスに従います：

1. 実装者は当該ステップの成果物を提出し、**必ず次のステップに進む前に明示的に「このステップは完了しました、確認をお願いします」と伝えてください**
2. レビュアーは成果物を確認し、問題があれば修正を依頼します
3. 問題がなければ「次のステップに進んでください」と明示的に指示します
4. 実装者は承認を受けてから次のステップに進みます

このプロセスにより、各段階での品質を担保し、手戻りを最小限に抑えることができます。

## 実装のポイント

### コントローラー
- シンプルに保ち、単一の責務に集中させる
- 複雑なロジックはサービスクラスに委譲する
- リクエスト検証にはFormRequestを使用する
- レスポンス生成にはResourceクラスを使用する

### FormRequest
- バリデーションルールを明確に定義する
- カスタムバリデーションメッセージを提供する
- 日本語の属性名を定義して親切なエラーメッセージを実現する

### Resource
- 一貫したレスポンスフォーマットを維持する
- 必要に応じてデータを変換する
- ネストされたリレーションを適切に処理する

### エラーハンドリング
- 適切なHTTPステータスコードを使用する
- エラーメッセージは具体的かつユーザーフレンドリーにする
- デバッグ情報は本番環境では表示しない

## その他の参考ドキュメント

- [バリデーション設計](validation.md)
- [APIレスポンス設計](api-responses.md)
- [認証方法](authentication.md)
- [ディレクトリ構成](directory-path.md)
- [エラーハンドリング](error-handling-logging.md) 